// Copyright (C) 2018, Jaguar Land Rover
// This program is licensed under the terms and conditions of the
// Mozilla Public License, version 2.0.  The full text of the 
// Mozilla Public License is at https://www.mozilla.org/MPL/2.0/
//
// Author: Magnus Feuer (mfeuer1@jaguarlandrover.com)
//
// Running example code from README.md in https://github.com/PDXOSTC/dstc
//

#include <stdio.h>
#include <stdlib.h>
#include "dstc.h"

// Generate deserializer for multicast packets sent by dstc_message()
// above.
// The deserializer decodes the incoming data and calls the
// print_name_and_age() function in this file.
//
static void dstc_server_dynamic_message (uint8_t * data)
{
  extern void dynamic_message (DSTC _a1[1]);
  DSTC _a1[1];
  if (*(uint32_t *) "DSTC" == 0x43545344)
    {
      ((dstc_dynamic_data_t *) _a1)->length = *((uint32_t *) data);
      data += sizeof (uint32_t);
      ((dstc_dynamic_data_t *) _a1)->data = data;
      data += ((dstc_dynamic_data_t *) _a1)->length;
    }
  else
    {
      if (sizeof (DSTC[1]) == sizeof (DSTC))
	memcpy ((void *) &_a1, (void *) data, sizeof (DSTC[1]));
      else
	memcpy ((void *) _a1, (void *) data, sizeof (DSTC[1]));
      data += sizeof (DSTC[1]);
    }
  dynamic_message (_a1);
  return;
}

static void __attribute__ ((constructor)) _dstc_register_dynamic_message ()
{
  extern void dstc_register_function (char *, void (*)(uint8_t *));
  dstc_register_function ("dynamic_message", dstc_server_dynamic_message);
}


//
// Print out name and age.
// Invoked by deserilisation code generated by DSTC_SERVER() above.
// Please note that the arguments must match between the function below
// and the macro above.
//
void dynamic_message(dstc_dynamic_data_t* dynarg)
{
    printf("Data:   %*s\n", dynarg->length, (char*) dynarg->data);
    printf("Length: %d\n", dynarg->length);
}

int main(int argc, char* argv[])
{
    while(1) {
        dstc_read();
    }
        
    exit(0);
}


